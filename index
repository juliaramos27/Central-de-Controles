<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central de Controlo | Gestão de Planilhas</title>
    
    <!-- Scripts Base -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #000; color: #fff; font-family: system-ui, -apple-system, sans-serif; }
        .orange-accent { color: #f5510b; }
        .bg-orange-accent { background-color: #f5510b; }
        .border-orange-accent { border-color: #f5510b; }
        
        .card-item {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-item:hover {
            border-color: #f5510b66;
            transform: translateY(-2px);
            background: #0d0d0d;
        }

        /* Scrollbar Personalizada */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #f5510b; }

        .loader {
            border: 3px solid #111;
            border-top: 3px solid #f5510b;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Credenciais Oficiais do Projeto
        const firebaseConfig = {
            apiKey: "AIzaSyBFsQEUSa3IzXT31ziv-brAOR-hL79K0-k",
            authDomain: "central-de-controles.firebaseapp.com",
            projectId: "central-de-controles",
            storageBucket: "central-de-controles.firebasestorage.app",
            messagingSenderId: "278219312174",
            appId: "1:278219312174:web:05f22ca9c0aee15ec5e3bf"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "central-de-controles";

        // Exportação global segura para o React
        window.FB_APP = {
            db, auth, appId,
            methods: { collection, addDoc, onSnapshot, query, doc, updateDoc, deleteDoc, signInAnonymously, signInWithCustomToken, onAuthStateChanged, serverTimestamp }
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const App = () => {
            const [sheets, setSheets] = useState([]);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [isAdding, setIsAdding] = useState(false);
            const [newEntry, setNewEntry] = useState({ assunto: '', responsavel: '', link: '', status: 'Em Andamento' });

            // 1. Autenticação (Obrigatório: Auth antes de Queries)
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        const auth = window.FB_APP.auth;
                        // Verifica se existe um token de ambiente ou usa login anónimo
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await window.FB_APP.methods.signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await window.FB_APP.methods.signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Falha na autenticação:", err);
                        // Se falhar o login anónimo, o programador deve ativar o provedor no Firebase Console
                        if (err.code === 'auth/admin-restricted-operation') {
                            setError("Login Anónimo Desativado. Ativa o provedor 'Anónimo' no teu Console do Firebase (Authentication > Sign-in method).");
                        } else {
                            setError("Erro de Autenticação: " + err.message);
                        }
                        setLoading(false);
                    }
                };
                
                initAuth();
                
                const unsubscribe = window.FB_APP.methods.onAuthStateChanged(window.FB_APP.auth, (u) => {
                    if (u) {
                        setUser(u);
                        setError(null);
                    }
                });
                
                return () => unsubscribe();
            }, []);

            // 2. Sincronização em Tempo Real (Apenas se autenticado)
            useEffect(() => {
                if (!user) return;

                const colRef = window.FB_APP.methods.collection(
                    window.FB_APP.db, 
                    'artifacts', window.FB_APP.appId, 'public', 'data', 'sheets'
                );

                const q = window.FB_APP.methods.query(colRef);
                
                const unsubscribe = window.FB_APP.methods.onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    // Ordenação alfabética por assunto
                    setSheets(data.sort((a, b) => (a.assunto || '').localeCompare(b.assunto || '')));
                    setLoading(false);
                    setTimeout(() => { if(window.lucide) window.lucide.createIcons(); }, 150);
                }, (err) => {
                    console.error("Erro no Firestore:", err);
                    setError("Erro de Permissão. Verifica se as 'Rules' do teu Firestore estão em modo de teste ou permitem acesso.");
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user]);

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [isAdding, searchTerm, sheets]);

            const filteredData = useMemo(() => {
                return sheets.filter(s => 
                    (s.assunto || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (s.responsavel || '').toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [sheets, searchTerm]);

            const handleCreate = async (e) => {
                e.preventDefault();
                if (!user || !newEntry.assunto || !newEntry.link) return;

                try {
                    await window.FB_APP.methods.addDoc(
                        window.FB_APP.methods.collection(window.FB_APP.db, 'artifacts', window.FB_APP.appId, 'public', 'data', 'sheets'),
                        { 
                            ...newEntry, 
                            responsavel: newEntry.responsavel.toUpperCase(),
                            createdAt: window.FB_APP.methods.serverTimestamp() 
                        }
                    );
                    setNewEntry({ assunto: '', responsavel: '', link: '', status: 'Em Andamento' });
                    setIsAdding(false);
                } catch (err) {
                    alert("Erro ao gravar: " + err.message);
                }
            };

            const toggleStatus = async (item) => {
                if (!user) return;
                const nextStatus = item.status === 'Concluído' ? 'Em Andamento' : 'Concluído';
                const docRef = window.FB_APP.methods.doc(window.FB_APP.db, 'artifacts', window.FB_APP.appId, 'public', 'data', 'sheets', item.id);
                try {
                    await window.FB_APP.methods.updateDoc(docRef, { status: nextStatus });
                } catch (err) {
                    console.error("Erro ao atualizar status:", err);
                }
            };

            const handleDelete = async (id) => {
                if (!user) return;
                if (window.confirm("Pretende remover este registo permanentemente da nuvem?")) {
                    const docRef = window.FB_APP.methods.doc(window.FB_APP.db, 'artifacts', window.FB_APP.appId, 'public', 'data', 'sheets', id);
                    await window.FB_APP.methods.deleteDoc(docRef);
                }
            };

            if (loading) return (
                <div className="h-screen flex items-center justify-center bg-black">
                    <div className="text-center">
                        <div className="loader mx-auto mb-4"></div>
                        <p className="text-zinc-600 text-[10px] font-bold uppercase tracking-[0.5em]">Conectando Cloud</p>
                    </div>
                </div>
            );

            if (error) return (
                <div className="h-screen flex items-center justify-center bg-black p-6">
                    <div className="max-w-md w-full bg-zinc-900 border border-red-500/50 rounded-3xl p-8 text-center shadow-2xl">
                        <i data-lucide="alert-circle" className="w-12 h-12 text-red-500 mx-auto mb-4"></i>
                        <h2 className="text-xl font-bold mb-4">Erro de Configuração</h2>
                        <p className="text-zinc-400 text-sm mb-6 leading-relaxed">{error}</p>
                        <button 
                            onClick={() => window.location.reload()}
                            className="bg-orange-accent hover:bg-[#d44509] px-8 py-3 rounded-xl font-bold text-sm transition-all"
                        >
                            Tentar Novamente
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="max-w-6xl mx-auto px-4 py-8 md:py-16">
                    {/* Header */}
                    <div className="flex flex-col md:flex-row justify-between items-center gap-8 mb-16">
                        <div className="flex items-center gap-5">
                            <div className="w-16 h-16 bg-orange-accent rounded-[24px] flex items-center justify-center shadow-2xl shadow-[#f5510b]/30">
                                <i data-lucide="layout-grid" className="text-white w-8 h-8"></i>
                            </div>
                            <div>
                                <h1 className="text-3xl font-black uppercase italic tracking-tighter">Central de Controlo</h1>
                                <div className="flex items-center gap-2 mt-1">
                                    <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                                    <p className="text-[10px] text-zinc-500 font-bold uppercase tracking-widest">Servidor Online</p>
                                </div>
                            </div>
                        </div>

                        <button 
                            onClick={() => setIsAdding(!isAdding)}
                            className="w-full md:w-auto bg-orange-accent hover:bg-[#d44509] text-white px-10 py-4 rounded-2xl font-black uppercase text-xs tracking-widest flex items-center justify-center gap-3 transition-all active:scale-95 shadow-xl"
                        >
                            <i data-lucide={isAdding ? "x" : "plus"} className="w-5 h-5"></i>
                            {isAdding ? "Fechar" : "Novo Levantamento"}
                        </button>
                    </div>

                    {/* Barra de Pesquisa */}
                    <div className="relative mb-12 group">
                        <i data-lucide="search" className="absolute left-6 top-1/2 -translate-y-1/2 text-zinc-700 group-focus-within:text-[#f5510b] transition-colors w-5 h-5"></i>
                        <input 
                            type="text" 
                            placeholder="Filtrar por assunto ou núcleo..." 
                            className="w-full bg-[#080808] border border-zinc-900 rounded-3xl py-6 pl-16 pr-8 focus:outline-none focus:border-[#f5510b] transition-all text-lg placeholder:text-zinc-800"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                        />
                    </div>

                    {/* Formulário */}
                    {isAdding && (
                        <div className="mb-12 p-10 rounded-[40px] border-2 border-orange-accent bg-[#0a0a0a] animate-in fade-in zoom-in duration-300 shadow-2xl">
                            <h2 className="text-2xl font-bold mb-8 flex items-center gap-3">
                                <i data-lucide="database" className="text-[#f5510b]"></i> Novo Registo Cloud
                            </h2>
                            <form onSubmit={handleCreate} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                                <div className="space-y-3">
                                    <label className="text-[10px] font-black text-zinc-600 uppercase ml-1 tracking-widest">Nome do Levantamento</label>
                                    <input required className="w-full bg-black border border-zinc-800 p-5 rounded-2xl focus:border-[#f5510b] outline-none transition-all" placeholder="Nome da planilha" value={newEntry.assunto} onChange={e => setNewEntry({...newEntry, assunto: e.target.value})} />
                                </div>
                                <div className="space-y-3">
                                    <label className="text-[10px] font-black text-zinc-600 uppercase ml-1 tracking-widest">Núcleo Responsável</label>
                                    <input required className="w-full bg-black border border-zinc-800 p-5 rounded-2xl focus:border-[#f5510b] outline-none transition-all uppercase" placeholder="GESTORES, ANJOS, etc" value={newEntry.responsavel} onChange={e => setNewEntry({...newEntry, responsavel: e.target.value})} />
                                </div>
                                <div className="space-y-3">
                                    <label className="text-[10px] font-black text-zinc-600 uppercase ml-1 tracking-widest">URL da Planilha</label>
                                    <input required className="w-full bg-black border border-zinc-800 p-5 rounded-2xl focus:border-[#f5510b] outline-none transition-all" placeholder="https://docs.google..." value={newEntry.link} onChange={e => setNewEntry({...newEntry, link: e.target.value})} />
                                </div>
                                <div className="md:col-span-3 flex justify-end mt-4">
                                    <button className="bg-white text-black px-14 py-4 rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-orange-accent hover:text-white transition-all shadow-2xl">
                                        Guardar na Nuvem
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}

                    {/* Grid de Dados */}
                    <div className="grid gap-5">
                        {filteredData.length > 0 ? filteredData.map(item => (
                            <div key={item.id} className="card-item rounded-[32px] p-6 flex flex-col md:flex-row md:items-center gap-8 group">
                                <div className="flex items-center gap-6 md:w-5/12">
                                    <button 
                                        onClick={() => toggleStatus(item)}
                                        className={`w-16 h-16 rounded-2xl flex items-center justify-center transition-all ${item.status === 'Concluído' ? 'bg-green-500/10 text-green-500' : 'bg-[#f5510b]/10 text-[#f5510b]'}`}
                                    >
                                        <i data-lucide={item.status === 'Concluído' ? "check-circle" : "clock"} className="w-8 h-8"></i>
                                    </button>
                                    <div className="min-w-0">
                                        <span className={`text-[10px] font-black uppercase tracking-[0.25em] ${item.status === 'Concluído' ? 'text-green-500' : 'text-[#f5510b]'}`}>{item.status}</span>
                                        <h3 className="text-xl font-bold text-zinc-200 group-hover:text-white transition-colors truncate pr-4 leading-tight">{item.assunto}</h3>
                                    </div>
                                </div>

                                <div className="flex-grow">
                                    <p className="text-[10px] text-zinc-700 font-bold uppercase mb-2 tracking-widest">Responsabilidade</p>
                                    <div className="flex items-center gap-3">
                                        <div className="w-2.5 h-2.5 rounded-full bg-orange-accent shadow-[0_0_10px_#f5510b]"></div>
                                        <span className="text-sm font-black text-zinc-400 uppercase tracking-tighter">{item.responsavel || 'GERAL'}</span>
                                    </div>
                                </div>

                                <div className="flex items-center gap-4 ml-auto pt-6 md:pt-0 border-t md:border-t-0 border-zinc-900 w-full md:w-auto">
                                    <a 
                                        href={item.link} 
                                        target="_blank" 
                                        className="flex-grow md:flex-grow-0 bg-white text-black px-10 py-4 rounded-2xl text-[12px] font-black uppercase tracking-[0.15em] hover:bg-orange-accent hover:text-white transition-all text-center"
                                    >
                                        Aceder <i data-lucide="external-link" className="w-4 h-4 inline ml-2 mb-1"></i>
                                    </a>
                                    <button onClick={() => handleDelete(item.id)} className="p-4 text-zinc-800 hover:text-red-500 transition-colors">
                                        <i data-lucide="trash-2" className="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                        )) : (
                            <div className="py-32 text-center border-2 border-dashed border-zinc-900 rounded-[60px] bg-[#020202]">
                                <i data-lucide="cloud-off" className="w-20 h-20 text-zinc-900 mx-auto mb-8"></i>
                                <p className="text-zinc-700 font-bold uppercase text-xs tracking-[0.5em]">Nenhum dado sincronizado</p>
                            </div>
                        )}
                    </div>

                    {/* Footer */}
                    <footer className="mt-24 text-center border-t border-zinc-950 pt-16">
                        <div className="flex items-center justify-center gap-4 mb-6">
                            <span className="h-px w-10 bg-zinc-900"></span>
                            <span className="text-zinc-800 text-[11px] font-black uppercase tracking-[0.7em]">Central de Controlo &copy; 2025</span>
                            <span className="h-px w-10 bg-zinc-900"></span>
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
